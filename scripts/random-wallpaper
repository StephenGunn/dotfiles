#!/usr/bin/env bash

# Random Wallpaper Selector
# Selects a random wallpaper from the current theme's wallpaper directory using waypaper

set -e

# Get the theme switcher project directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
CURRENT_THEME_FILE="$HOME/.config/current-theme"

# Read current theme
if [ ! -f "$CURRENT_THEME_FILE" ]; then
    echo "Error: No current theme set. Run theme-switch first."
    notify-send "Wallpaper Error" "No theme set. Run theme-switch first." -u critical
    exit 1
fi

THEME_NAME=$(cat "$CURRENT_THEME_FILE")
WALLPAPER_DIR="$DOTFILES_DIR/.config/theme-switcher/themes/$THEME_NAME/wallpapers"

# Check if wallpaper directory exists
if [ ! -d "$WALLPAPER_DIR" ]; then
    echo "Error: Wallpaper directory not found: $WALLPAPER_DIR"
    notify-send "Wallpaper Error" "No wallpapers found for theme: $THEME_NAME" -u critical
    exit 1
fi

# Check if waypaper is installed
if ! command -v waypaper &> /dev/null; then
    echo "Error: waypaper not found"
    notify-send "Wallpaper Error" "waypaper is not installed" -u critical
    exit 1
fi

# Use waypaper's built-in random selector with the theme's wallpaper folder
waypaper --random --folder "$WALLPAPER_DIR" --backend hyprpaper

# Create symlink at ~/.config/background for HyprPanel
# Read the wallpaper path from waypaper's config
WAYPAPER_CONFIG="$HOME/.config/waypaper/config.ini"
if [ -f "$WAYPAPER_CONFIG" ]; then
    SELECTED_WALLPAPER=$(grep "^wallpaper = " "$WAYPAPER_CONFIG" | cut -d'=' -f2- | xargs)
    # Expand tilde to full path
    SELECTED_WALLPAPER="${SELECTED_WALLPAPER/#\~/$HOME}"

    if [ -n "$SELECTED_WALLPAPER" ] && [ -f "$SELECTED_WALLPAPER" ]; then
        ln -sf "$SELECTED_WALLPAPER" "$HOME/.config/background"
        echo "Created symlink: ~/.config/background -> $SELECTED_WALLPAPER"
    fi
fi

notify-send "Random Wallpaper" "Applied random wallpaper from $THEME_NAME theme"
